import asyncio
import os
import time
from contextlib import suppress
from datetime import datetime
from ssl import SSLContext

import aiohttp
import config
import discord
import quart
from aiohttp import web
from discord.ext import commands, tasks
from hypercorn.asyncio import serve
from hypercorn.config import Config
from quart import Quart, abort
from utils.subclasses import AnimeContext

# app = Quart("vote_manager")
# shut_down = asyncio.Event()


class VoteManager(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.app = web.Application()
        self.voted_role.start()
        self.bot.loop.create_task(self.run())

    def cog_unload(self):
        self.bot.loop.create_task(self._webserver.stop())
        self.voted_role.cancel()

    @tasks.loop(minutes=1)
    async def voted_role(self):
        await self.bot.wait_until_ready()
        votes = await self.bot.db.fetch("SELECT user_id FROM votes")
        guild = self.bot.get_guild(786359602241470464)
        await guild.chunk() if not guild.chunked else ...
        for i in votes:
            user_id = i["user_id"]
            if user_id in guild._members.keys():
                member = guild.get_member(user_id)
                if not member._roles.has(842564732078522418):
                    await member.add_roles(discord.Object(842564732078522418))

    async def give_role(self, user_id):
        guild = self.bot.get_guild(786359602241470464)
        await guild.chunk() if not guild.chunked else ...
        if user_id in guild._members.keys():
            member = guild.get_member(user_id)
            if not member._roles.has(842564732078522418):
                await member.add_roles(discord.Object(842564732078522418))

    async def votes(self, request):
        if not request.headers.get("Authorization"):
            return web.Response(status=401, text="Unauthorized")
        if request.headers.get("Authorization") not in [
            config.vote_webhook_token,
            config.botlist_space,
        ]:
            return web.Response(status=401, text="Unauthorized")
        data = await request.json()
        try:
            if data.get("site"):
                if data.get("site") == "botlist.space":
                    user_id = data.get("user").get("id")
            else:
                user_id = data.get("user") or data.get("id")
            user = await self.bot.getch(user_id)
            vote_counts = await self.bot.db.fetchval(
                (
                    "INSERT INTO votes (user_id, count) VALUES ($1, $2)"
                    " ON CONFLICT (user_id) "
                    "DO UPDATE SET count = votes.count + 1"
                    " RETURNING count"
                ),
                user.id,
                1,
            )
            await self.bot.db.execute(
                "UPDATE votes SET recent_voted = $2 WHERE user_id = $1", user.id, datetime.utcnow()
            )
            await self.bot.get_cog("Economy").change_balance(user.id, 10000)
            self.bot.loop.create_task(self.give_role(user.id))
            await user.send(
                f"Hey, {str(user)} Thanks for voting it mean a lot, as a reward I have gave you 10000 bobo run `ovo bal` to see it, you have voted {vote_counts} times for The Anime Bot thank you so much."
            )
            await self.bot.get_channel(791518421920907265).send(
                f"{str(user)}, just upvoted our bot, this is their {vote_counts} times voting for The Anime Bot"
            )
        except Exception as e:
            return web.Response(status=500)
        return web.Response(status=200, text="OK")

    async def index(self, request):
        return web.Response(text=f"In {len(self.bot.guilds)} guilds, with {len(self.bot.users)} users")

    async def run(self):
        await self.bot.wait_until_ready()
        self.app.router.add_get("/", self.index)
        self.app.router.add_post("/votes", self.votes)
        runner = web.AppRunner(self.app)
        await runner.setup()
        self._webserver = web.TCPSite(runner, "0.0.0.0", "15000")
        await self._webserver.start()

    # @app.route("/")
    # async def index(self):
    #     return {"hello": "o"}


def setup(bot):
    bot.add_cog(VoteManager(bot))
